# Enterprise Multi-Portal Apache HTTP Server Configuration
# Supports: Customer Portal, Admin Dashboard, Vendor Portal, Mobile App

ServerRoot "/usr/local/apache2"
Listen 80
Listen 443 ssl

# Load essential modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule security2_module modules/mod_security2.so
LoadModule evasive24_module modules/mod_evasive24.so

# Basic server configuration
ServerName ecommerce.local
ServerAdmin admin@ecommerce.local
DirectoryIndex index.html

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https: data:; connect-src 'self' https: wss:"

# Performance optimizations
Header always set Cache-Control "public, max-age=31536000" "expr=%{REQUEST_URI} =~ m#\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$#"
Header always set Cache-Control "no-cache, no-store, must-revalidate" "expr=%{REQUEST_URI} =~ m#\.(html)$#"

# Compression
LoadModule deflate_module modules/mod_deflate.so
SetOutputFilter DEFLATE
SetEnvIfNoCase Request_URI \
    \.(?:gif|jpe?g|png)$ no-gzip dont-vary
SetEnvIfNoCase Request_URI \
    \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary

# Rate limiting and DDoS protection
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        5
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# SSL Configuration
SSLEngine on
SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder on
SSLSessionCache "shmcb:/usr/local/apache2/logs/ssl_scache(512000)"
SSLSessionCacheTimeout 300

# Self-signed certificates for development (use Let's Encrypt in production)
SSLCertificateFile /usr/local/apache2/conf/ssl/server.crt
SSLCertificateKeyFile /usr/local/apache2/conf/ssl/server.key

# Backend API proxy configuration
ProxyPreserveHost On
ProxyAddHeaders On

# API Gateway backend
ProxyPass /api/ http://api-gateway:8080/api/
ProxyPassReverse /api/ http://api-gateway:8080/api/

# Intelligent Monitoring API proxy
ProxyPass /monitoring-api/ http://intelligent-monitoring-service:8090/api/monitoring/
ProxyPassReverse /monitoring-api/ http://intelligent-monitoring-service:8090/api/monitoring/

# Health check endpoint for load balancer
<Location "/health">
    SetHandler server-status
    Require ip 10.0.0.0/8
    Require ip 172.16.0.0/12
    Require ip 192.168.0.0/16
    Require local
</Location>

# ==========================================
# CUSTOMER PORTAL (shop.ecommerce.com)
# Public e-commerce website
# ==========================================

<VirtualHost *:80>
    ServerName shop.ecommerce.local
    ServerAlias shop.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/customer-portal"
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName shop.ecommerce.local
    ServerAlias shop.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/customer-portal"
    
    SSLEngine on
    
    # Logging
    ErrorLog logs/customer-portal-error.log
    CustomLog logs/customer-portal-access.log combined
    
    # Customer portal directory configuration
    <Directory "/usr/local/apache2/htdocs/customer-portal">
        AllowOverride All
        Require all granted
        
        # Angular SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Static assets optimization
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </LocationMatch>
    
    # Security headers for customer portal
    Header always set X-Portal-Type "customer"
    Header always set X-Environment "production"
    
    # Customer analytics headers
    Header always set X-Customer-Segment "public"
    Header always set X-Portal-Version "1.0.0"
</VirtualHost>

# ==========================================
# ADMIN DASHBOARD (admin.ecommerce.com)
# Business administration interface
# ==========================================

<VirtualHost *:80>
    ServerName admin.ecommerce.local
    ServerAlias admin.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/admin-dashboard"
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName admin.ecommerce.local
    ServerAlias admin.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/admin-dashboard"
    
    SSLEngine on
    
    # Logging
    ErrorLog logs/admin-dashboard-error.log
    CustomLog logs/admin-dashboard-access.log combined
    
    # Enhanced security for admin portal
    <Directory "/usr/local/apache2/htdocs/admin-dashboard">
        AllowOverride All
        
        # IP whitelisting (configure for your admin IPs)
        # Require ip 10.0.0.0/8
        # Require ip 172.16.0.0/12
        # Require ip 192.168.0.0/16
        Require all granted  # For development, restrict in production
        
        # Angular SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Additional security headers for admin
    Header always set X-Portal-Type "admin"
    Header always set X-Frame-Options "DENY"
    Header always set X-Robots-Tag "noindex, nofollow"
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    
    # Admin-specific monitoring endpoints
    ProxyPass /admin-monitoring/ http://intelligent-monitoring-service:8090/api/monitoring/
    ProxyPassReverse /admin-monitoring/ http://intelligent-monitoring-service:8090/api/monitoring/
    
    # Grafana proxy for admin dashboard
    ProxyPass /grafana/ http://grafana:3000/
    ProxyPassReverse /grafana/ http://grafana:3000/
    
    # Prometheus proxy for admin dashboard
    ProxyPass /prometheus/ http://prometheus:9090/
    ProxyPassReverse /prometheus/ http://prometheus:9090/
</VirtualHost>

# ==========================================
# VENDOR PORTAL (vendor.ecommerce.com)
# Seller/vendor management interface
# ==========================================

<VirtualHost *:80>
    ServerName vendor.ecommerce.local
    ServerAlias vendor.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/vendor-portal"
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName vendor.ecommerce.local
    ServerAlias vendor.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/vendor-portal"
    
    SSLEngine on
    
    # Logging
    ErrorLog logs/vendor-portal-error.log
    CustomLog logs/vendor-portal-access.log combined
    
    # Vendor portal directory configuration
    <Directory "/usr/local/apache2/htdocs/vendor-portal">
        AllowOverride All
        Require all granted
        
        # Angular SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Vendor-specific headers
    Header always set X-Portal-Type "vendor"
    Header always set X-Vendor-API-Version "1.0.0"
    
    # Vendor file upload handling
    <Location "/vendor-uploads">
        # File upload size limits
        LimitRequestBody 52428800  # 50MB
        
        # File type restrictions
        <FilesMatch "\.(exe|bat|sh|com|pif|scr|vbs|cmd)$">
            Require all denied
        </FilesMatch>
    </Location>
    
    # Vendor analytics
    Header always set X-Customer-Segment "vendor"
    Header always set X-Business-Type "b2b"
</VirtualHost>

# ==========================================
# MOBILE APP (m.ecommerce.com)
# Progressive Web App for mobile
# ==========================================

<VirtualHost *:80>
    ServerName m.ecommerce.local
    ServerAlias m.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/mobile-app"
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName m.ecommerce.local
    ServerAlias m.ecommerce.com
    DocumentRoot "/usr/local/apache2/htdocs/mobile-app"
    
    SSLEngine on
    
    # Logging
    ErrorLog logs/mobile-app-error.log
    CustomLog logs/mobile-app-access.log combined
    
    # Mobile app directory configuration
    <Directory "/usr/local/apache2/htdocs/mobile-app">
        AllowOverride All
        Require all granted
        
        # Angular SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # PWA specific headers
    Header always set X-Portal-Type "mobile"
    Header always set X-PWA-Version "1.0.0"
    
    # Service Worker caching
    <Files "sw.js">
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </Files>
    
    # App manifest
    <Files "manifest.json">
        Header always set Content-Type "application/manifest+json"
    </Files>
    
    # Mobile-specific optimizations
    Header always set X-Customer-Segment "mobile"
    Header always set X-Device-Type "mobile"
    
    # Offline support
    <LocationMatch "\.(html|js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
        Header always set Cache-Control "public, max-age=31536000"
    </LocationMatch>
</VirtualHost>

# ==========================================
# DEFAULT VIRTUAL HOST
# Fallback for unmatched domains
# ==========================================

<VirtualHost *:80>
    ServerName default.ecommerce.local
    DocumentRoot "/usr/local/apache2/htdocs/default"
    
    # Redirect to main customer portal
    RewriteEngine On
    RewriteRule ^(.*)$ https://shop.ecommerce.local$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName default.ecommerce.local
    DocumentRoot "/usr/local/apache2/htdocs/default"
    
    SSLEngine on
    
    # Simple fallback page
    <Directory "/usr/local/apache2/htdocs/default">
        AllowOverride None
        Require all granted
    </Directory>
    
    # Redirect to main customer portal
    RewriteEngine On
    RewriteRule ^(.*)$ https://shop.ecommerce.local$1 [R=301,L]
</VirtualHost>

# ==========================================
# CORS CONFIGURATION
# Cross-Origin Resource Sharing
# ==========================================

<LocationMatch "^/api/">
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Session-ID, X-User-Action, X-Source-Page, X-Customer-Segment, X-Cart-Items-Count, X-Order-Value, X-User-Email, X-API-Version, X-Client-Version"
    Header always set Access-Control-Expose-Headers "X-Trace-ID, X-Span-ID"
    Header always set Access-Control-Max-Age "3600"
    
    # Handle preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</LocationMatch>

# ==========================================
# MONITORING AND HEALTH CHECKS
# ==========================================

<Location "/server-status">
    SetHandler server-status
    Require local
    Require ip 10.0.0.0/8
    Require ip 172.16.0.0/12
    Require ip 192.168.0.0/16
</Location>

<Location "/server-info">
    SetHandler server-info
    Require local
    Require ip 10.0.0.0/8
    Require ip 172.16.0.0/12
    Require ip 192.168.0.0/16
</Location>

# ==========================================
# ERROR PAGES
# ==========================================

ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html
ErrorDocument 503 /error/503.html

# ==========================================
# MIME TYPES
# ==========================================

TypesConfig conf/mime.types

# Modern web formats
AddType application/javascript .js
AddType text/css .css
AddType application/json .json
AddType application/manifest+json .webmanifest
AddType image/svg+xml .svg
AddType application/font-woff .woff
AddType application/font-woff2 .woff2

# ==========================================
# LOG CONFIGURATION
# ==========================================

LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_with_time
LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" proxy_combined

# Main access log
CustomLog logs/access.log combined_with_time

# Error log with detailed level
ErrorLog logs/error.log
LogLevel warn

# Separate logs for monitoring
LogFormat "%h %t \"%r\" %>s %O \"%{User-Agent}i\" \"%{X-Portal-Type}o\" \"%{X-Customer-Segment}o\"" monitoring
CustomLog logs/monitoring.log monitoring