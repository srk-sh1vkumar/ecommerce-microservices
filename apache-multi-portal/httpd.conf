# Apache Multi-Portal Configuration for Enterprise Ecommerce Platform
# Supports: Customer Portal, Admin Dashboard, Vendor Portal, Mobile PWA

ServerRoot "/usr/local/apache2"
Listen 80
Listen 443 ssl

# Core Modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule headers_module modules/mod_headers.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule status_module modules/mod_status.so
LoadModule info_module modules/mod_info.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule security2_module modules/mod_security2.so

# Basic Configuration
ServerName localhost
ServerAdmin admin@example.com
DirectoryIndex index.html index.htm

# Security Headers for all sites
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Performance and Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Expires Headers for Static Content
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# Rate Limiting (Basic DoS Protection)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        20
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# SSL Configuration
<IfModule mod_ssl.c>
    SSLEngine on
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # OCSP Stapling
    SSLUseStapling On
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
</IfModule>

# Proxy Configuration for Backend Services
ProxyPreserveHost On
ProxyRequests Off

# Backend Service Definitions
ProxyPass /health-check http://api-gateway:8080/actuator/health
ProxyPassReverse /health-check http://api-gateway:8080/actuator/health

# Global Error Pages
ErrorDocument 404 /error-pages/404.html
ErrorDocument 500 /error-pages/500.html
ErrorDocument 502 /error-pages/502.html
ErrorDocument 503 /error-pages/503.html

# Log Configuration
LogLevel warn
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined env=!dontlog

# Virtual Host Definitions

# ============================================================================
# 1. CUSTOMER PORTAL - shop.ecommerce.com (Public Ecommerce Website)
# ============================================================================
<VirtualHost *:80>
    ServerName shop.ecommerce.com
    ServerAlias www.shop.ecommerce.com
    DocumentRoot /var/www/customer-portal
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName shop.ecommerce.com
    ServerAlias www.shop.ecommerce.com
    DocumentRoot /var/www/customer-portal
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ecommerce.crt
    SSLCertificateKeyFile /etc/ssl/private/ecommerce.key
    
    # Security Headers for Customer Portal
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api-gateway:8080;"
    
    # Static Content Serving
    <Directory "/var/www/customer-portal">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Angular Router Support
        FallbackResource /index.html
    </Directory>
    
    # API Proxy to Backend Services
    ProxyPass /api/ http://api-gateway:8080/api/
    ProxyPassReverse /api/ http://api-gateway:8080/api/
    
    # Health Check
    ProxyPass /health http://api-gateway:8080/actuator/health
    ProxyPassReverse /health http://api-gateway:8080/actuator/health
    
    # Logging
    ErrorLog /var/log/apache2/customer-portal-error.log
    CustomLog /var/log/apache2/customer-portal-access.log combined
</VirtualHost>

# ============================================================================
# 2. ADMIN DASHBOARD - admin.ecommerce.com (Business Administration Interface)
# ============================================================================
<VirtualHost *:80>
    ServerName admin.ecommerce.com
    DocumentRoot /var/www/admin-dashboard
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName admin.ecommerce.com
    DocumentRoot /var/www/admin-dashboard
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ecommerce.crt
    SSLCertificateKeyFile /etc/ssl/private/ecommerce.key
    
    # Enhanced Security for Admin Portal
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://api-gateway:8080 https://intelligent-monitoring-service:8090;"
    
    # IP Whitelisting for Admin Access (Configure as needed)
    <Directory "/var/www/admin-dashboard">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        # Require ip 192.168.1.0/24  # Uncomment and configure for IP restriction
        Require all granted
        
        # Angular Router Support
        FallbackResource /index.html
    </Directory>
    
    # API Proxy to Backend Services
    ProxyPass /api/ http://api-gateway:8080/api/
    ProxyPassReverse /api/ http://api-gateway:8080/api/
    
    # Monitoring API Proxy
    ProxyPass /monitoring/ http://intelligent-monitoring-service:8090/
    ProxyPassReverse /monitoring/ http://intelligent-monitoring-service:8090/
    
    # Grafana Proxy for Admin Dashboard
    ProxyPass /grafana/ http://grafana:3000/
    ProxyPassReverse /grafana/ http://grafana:3000/
    
    # Prometheus Proxy for Admin Dashboard
    ProxyPass /prometheus/ http://prometheus:9090/
    ProxyPassReverse /prometheus/ http://prometheus:9090/
    
    # Health Check
    ProxyPass /health http://api-gateway:8080/actuator/health
    ProxyPassReverse /health http://api-gateway:8080/actuator/health
    
    # Logging
    ErrorLog /var/log/apache2/admin-dashboard-error.log
    CustomLog /var/log/apache2/admin-dashboard-access.log combined
</VirtualHost>

# ============================================================================
# 3. VENDOR PORTAL - vendor.ecommerce.com (Seller/Vendor Management)
# ============================================================================
<VirtualHost *:80>
    ServerName vendor.ecommerce.com
    DocumentRoot /var/www/vendor-portal
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName vendor.ecommerce.com
    DocumentRoot /var/www/vendor-portal
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ecommerce.crt
    SSLCertificateKeyFile /etc/ssl/private/ecommerce.key
    
    # Security Headers for Vendor Portal
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api-gateway:8080;"
    
    # File Upload Size Limit for Vendor Portal
    LimitRequestBody 104857600  # 100MB for product images and documents
    
    <Directory "/var/www/vendor-portal">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Angular Router Support
        FallbackResource /index.html
    </Directory>
    
    # API Proxy to Backend Services
    ProxyPass /api/ http://api-gateway:8080/api/
    ProxyPassReverse /api/ http://api-gateway:8080/api/
    
    # File Upload Handling
    ProxyPass /upload/ http://api-gateway:8080/api/upload/
    ProxyPassReverse /upload/ http://api-gateway:8080/api/upload/
    
    # Health Check
    ProxyPass /health http://api-gateway:8080/actuator/health
    ProxyPassReverse /health http://api-gateway:8080/actuator/health
    
    # Logging
    ErrorLog /var/log/apache2/vendor-portal-error.log
    CustomLog /var/log/apache2/vendor-portal-access.log combined
</VirtualHost>

# ============================================================================
# 4. MOBILE PWA - m.ecommerce.com (Progressive Web App)
# ============================================================================
<VirtualHost *:80>
    ServerName m.ecommerce.com
    DocumentRoot /var/www/mobile-app
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName m.ecommerce.com
    DocumentRoot /var/www/mobile-app
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ecommerce.crt
    SSLCertificateKeyFile /etc/ssl/private/ecommerce.key
    
    # PWA Specific Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api-gateway:8080; manifest-src 'self';"
    
    # Service Worker Caching Headers
    <Files "sw.js">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </Files>
    
    # Manifest File
    <Files "manifest.json">
        Header set Content-Type "application/manifest+json"
    </Files>
    
    <Directory "/var/www/mobile-app">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Angular Router Support
        FallbackResource /index.html
    </Directory>
    
    # API Proxy to Backend Services
    ProxyPass /api/ http://api-gateway:8080/api/
    ProxyPassReverse /api/ http://api-gateway:8080/api/
    
    # Health Check
    ProxyPass /health http://api-gateway:8080/actuator/health
    ProxyPassReverse /health http://api-gateway:8080/actuator/health
    
    # Logging
    ErrorLog /var/log/apache2/mobile-app-error.log
    CustomLog /var/log/apache2/mobile-app-access.log combined
</VirtualHost>

# ============================================================================
# STATUS AND MONITORING ENDPOINTS
# ============================================================================
<VirtualHost *:80>
    ServerName status.ecommerce.com
    
    <Location "/server-status">
        SetHandler server-status
        Require local
        Require ip 127.0.0.1
        Require ip 192.168.0.0/16
    </Location>
    
    <Location "/server-info">
        SetHandler server-info
        Require local
        Require ip 127.0.0.1
        Require ip 192.168.0.0/16
    </Location>
</VirtualHost>

# ============================================================================
# DEFAULT FALLBACK VIRTUAL HOST
# ============================================================================
<VirtualHost *:80>
    ServerName default
    DocumentRoot /var/www/default
    
    # Redirect unknown hosts to main customer portal
    RewriteEngine On
    RewriteRule ^(.*)$ https://shop.ecommerce.com$1 [R=301,L]
</VirtualHost>